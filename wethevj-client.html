<link rel="import" href="../core-scaffold/core-scaffold.html">
<link rel="import" href="../core-header-panel/core-header-panel.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-item/core-item.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-menu/core-submenu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../core-pages/core-pages.html">
<link rel="import" href="../polymer-ui-card/polymer-ui-card.html">
<link rel="import" href="../polymer-ajax/polymer-ajax.html" />
<link rel="import" href="../core-icons/iconsets/av-icons.html" />
<link rel="import" href="../polymer-ui-ratings/polymer-ui-ratings.html" />
<link rel="import" href="../font-roboto/roboto.html" />
<link rel="import" href="../wethevj-client/wethevj-video-item.html" />
<link rel="import" href="../facebook-login/facebook-login.html" />
<link rel="import" href="../cw-vote/cw-vote.html" />
<link rel="import" href="../paper-progress/paper-progress.html" />
<link rel="import" href="../core-animation/core-animation.html">
<link rel="import" href="../core-animation/core-animation-group.html">
<link rel="import" href="../core-animation/web-animations.html">
<polymer-element name="wethevj-client" attributes="progress query page channel">
  <template>
    <style type="text/css">
    :host {
      font-family:'Roboto';
    }
    </style>
    <link rel="stylesheet" type="style/css" href="style.css" />
    
    <core-scaffold id="core_scaffold">
      <core-header-panel mode="seamed" id="core_header_panel" navigation flex>
        <core-toolbar id="core_toolbar">
          <paper-input label="Search" id="paper_input" inputvalue="{{query}}" flex></paper-input>
          <core-icon icon="search"></core-icon>
        </core-toolbar>
        <core-menu selected="{{page}}" valueattr="label" selectedindex="0" id="core_menu" theme="core-dark-theme">
          <paper-item label="PLAYLIST" icon="list" id="0" on-click="{{ menuClick }}" selected center-justified horizontal layout center active></paper-item>
          <paper-item label="EXPLORE" icon="explore" id="1" on-click="{{ menuClick }}" center horizontal layout center-justified></paper-item>
          <paper-item label="HISTORY" icon="history" id="2" on-click="{{ menuClick }}" center horizontal layout center-justified></paper-item>
          <paper-item label="FAVORITES" icon="favorite" id="3" on-click="{{ menuClick }}" center horizontal layout center-justified></paper-item>
          <paper-item label="CHATROOM" icon="account-circle" id="4" on-click="{{ menuClick }}" center horizontal layout center-justified></paper-item>
          <paper-item label="SETTINGS" icon="settings" id="5" on-click="{{ menuClick }}" center horizontal layout center-justified></paper-item>
          <paper-item label="SEARCH" icon="search" id="6" on-click="{{ menuClick }}" center horizontal layout center-justified></paper-item>
          FB Login:<br />
          <facebook-login appID="546051685467074"></facebook-login>
        </core-menu>
      </core-header-panel>
      <div id="div" tool><div horizontal layout flex>{{ $.core_menu.selectedItem.label }}</div></div>
      <core-pages selected="{{ $.core_menu.selectedItem.id }}" selectedindex="0" notap id="core_pages">
        <section id="playlist_page" active>
          <!-- PLAYLIST -->
          <paper-progress value="{{progress}}" id="paperProgress"></paper-progress>
          <polymer-ajax id="playlist_ajax" auto url="http://wethevj.com/wethevj/rpc.php" params='{"action":"get_queue", "type" : "json", "channel":"{{channel}}"}' handleas="json" on-polymer-response="{{ playlistResponse }}">
          </polymer-ajax>
            <polymer-ajax id="playlist_yt_ajax" auto url="https://www.googleapis.com/youtube/v3/videos" params='{"id":"{{playlist_vids}}", "key":"AIzaSyCP-KyJTdtbCJOSE6CHfSH-PvJeJlFVjUc", "part":"snippet"}' handleas="json" on-polymer-response="{{ playlistYtResponse }}">
          </polymer-ajax>
          
          <template repeat="{{video in playlist_videos.items}}">
          <div center horizontal layout center-justified>
              <wethevj-video-item vid="{{vid}}" id="{{vid}}" video="{{video}}" votes="{{votes}}" queue="{{queue}}" unresolved></wethevj-video-item>
            <cw-vote vid="{{vid}}" value="{{votes}}"></cw-vote>
          </div>
          </template>
            
        </section>
        <section id="explore_page">
          <!-- EXPLORE -->
          <polymer-ajax id="explore_axap" auto url="https://www.googleapis.com/youtube/v3/search" params='{"key":"AIzaSyCP-KyJTdtbCJOSE6CHfSH-PvJeJlFVjUc", "regionCode" : "US", "videoEmbeddable" : "true", "maxResults" : "25", "order" : "rating", "type" : "video", "videoCategoryId" : "10", "part":"snippet"}' handleas="json" on-polymer-response="{{ exploreResponse }}">
          </polymer-ajax>
          
          <template repeat="{{video in explore_videos.items}}">
            <wethevj-video-item video="{{video}}"></wethevj-video-item>
          </template>
                    
        </section>
        <section id="history_page">
          <h1>HISTORY</h1>
          <polymer-ajax id="history_ajax" auto url="http://wethevj.com/wethevj/rpc.php" params='{"action":"get_history", "type" : "csv", "filter" : "youtube", "channel":"{{channel}}"}' handleas="json" on-polymer-response="{{ historyResponse }}">
          </polymer-ajax>
          <polymer-ajax id="history_yt_ajax" auto url="https://www.googleapis.com/youtube/v3/videos" params='{"id":"{{history_vids}}", "key":"AIzaSyCP-KyJTdtbCJOSE6CHfSH-PvJeJlFVjUc", "part":"snippet"}' handleas="json" on-polymer-response="{{ historyYtResponse }}">
          </polymer-ajax>
          <template repeat="{{video in history_videos.items}}">
            <wethevj-video-item video="{{video}}" vid="{{vid}}" unresolved></wethevj-video-item>
            <core-animation></core-animation>
          </template>
        </section>
        <section id="favorites_page">
          <h1>FAVORITES</h1>
        </section>
        <section id="chat_page">
          <!-- CHAT -->
          <polymer-ui-card>
          <h1>CHAT</h1>

          </polymer-ui-card>
        </section>
        <section id="settings_page">
          <h1>SETTINGS</h1>
        </section>
        <section id="search_page">
          <h1>SEARCH</h1>
          <polymer-ajax id="polymer_ajax" auto url="http://gdata.youtube.com/feeds/api/videos/" params='{"alt":"json", "q":"{{$.paper_input.inputValue}}"}' handleas="json" on-polymer-response="{{ searchResponse }}">
          </polymer-ajax>
          
          <template id="template" repeat="{{video in search_videos.feed.entry}}">
            <wethevj-video-item video="{{video}}"></wethevj-video-item>
          </template>
        </section>
      </core-pages>
    </core-scaffold>
  </template>

  <script>

    Polymer('wethevj-client', {
      ready: function () {
          /* bind search bar to query attribute of my element */
          this.page="PLAYLIST";
          this.channel="unity88";
          this.progress = 10;
      },
      menuClick: function() {
          this.shadowRoot.querySelector('#core_scaffold').closeDrawer();
      },
      searchResponse: function (e,rs) {
          this.search_videos=rs.response;
          console.log(rs.response);
    	},
      exploreResponse: function (e,rs) {
          this.explore_videos=rs.response;
          this.progress += 10;
          console.log(rs.response);
    	},
      playlistResponse: function (e,rs) {
        /* get youtube videos */
        this.playlist_vids=e.detail.response.csv_list;
        /* get database queue */
        this.queue = e.detail.response.queue;
        /* update progress bar */
        this.progress += 10;
    	},
    	playlistYtResponse: function(e,rs) {
    	  this.playlist_videos=rs.response;
    	  this.progress += 20;
        console.log(rs);
        /* animate the cards */
        var i=0;
        var animations = "";
        for(video in rs.response.items) {
          console.log("animate this:");
          var targetElement = this.shadowRoot.querySelector('#'+video.id);
          console.log("target: "+ targetElement);
          var animation = new Animation(targetElement,[{opacity: '0'}, {opacity: '1.0'}], 2000);
          if(i>0) {
            animations += ",";
          }
          animations += animation;
          i++;
        }
        var animationGroup =  new AnimationGroup(new AnimationSequence(animations,{duration: 6000, delay: 3000, fill: 'none'}), {type: 'seq', iterations: 2, fill: 'forwards'});
        var player = document.timeline.play(animationGroup);
        
        console.log(rs);
    	},
      historyResponse: function (e,rs) {
          this.history_vids=e.detail.response;
          this.progress += 10;
          console.log(rs);
    	},
    	historyYtResponse: function(e,rs) {
    	    this.history_videos=rs.response;
    	    this.progress += 10;
          console.log(rs);
    	},
    	queryChanged: function(attr,newval,oldval) {
    	  /* not sure why but oldval is all that works, newval has a big object in it */
    	  if(newval!="") {
    	    console.log(newval);
      	  this.page="SEARCH";
    	  }
    	},
    	progressChanged: function(attr, newval, oldval) {
    	  console.log("Progress: "+ this.progress +"%");
    	  if(this.progress>=100) {
    	      this.setAttribute('resolved', 'false');
    	  }
    	},
    	pageChanged: function(attr, newval, oldval) {
    	  console.log("Page changed from "+ oldval +" to "+ newval);
    

    
    	},
    	connectedChanged: function() {
    	  console.log('connected');
    	  
    	},
    	created: function() {
    	  
    	}
    });
  
  </script>
</polymer-element>